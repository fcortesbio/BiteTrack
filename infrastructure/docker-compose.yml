# BiteTrack Unified Infrastructure
# All services orchestrated with Traefik reverse proxy
#
# Usage:
#   docker compose up -d          # Start all services
#   docker compose logs -f        # View logs
#   docker compose down           # Stop all services
#
# Access:
#   Frontend:  http://localhost
#   API:       http://localhost/api
#   MCP:       http://localhost/mcp
#   Traefik:   http://localhost:8080

services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.5
    container_name: bitetrack-traefik
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.traefik.address=:8080"
      - "--ping=true"
      - "--log.level=DEBUG"
    ports:
      - "80:80" # HTTP
      - "8080:8080" # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_logs:/var/log/traefik
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`localhost`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=traefik"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
  # MongoDB Service (replica set for transactions)
  mongodb:
    image: mongo:8.0-noble
    container_name: bitetrack-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017" # Exposed for local development
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    volumes:
      - mongodb_data:/data/db
      - ../keyfile:/etc/mongodb-keyfile:ro
    networks:
      - backend
      - web # Also on web network for external access
    entrypoint:
      - bash
      - -c
      - |
        cp /etc/mongodb-keyfile /tmp/keyfile
        chmod 400 /tmp/keyfile
        chown mongodb:mongodb /tmp/keyfile
        exec docker-entrypoint.sh mongod --replSet rs0 --bind_ip_all --keyFile /tmp/keyfile
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # MongoDB Replica Set Initialization
  mongodb-init:
    image: mongo:8.0-noble
    container_name: bitetrack-mongodb-init
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - backend
    entrypoint: >
      bash -c "sleep 5 &&
      mongosh --host mongodb:27017
      -u ${MONGO_ROOT_USERNAME} -p ${MONGO_ROOT_PASSWORD}
      --authenticationDatabase admin
      --eval '
        rs.initiate({
          _id: \"rs0\",
          members: [{ _id: 0, host: \"mongodb:27017\" }]
        })
      ' || true"
    restart: "no"

  # BiteTrack API Service
  bitetrack-api:
    build:
      context: ../services/api
      dockerfile: Dockerfile
    container_name: bitetrack-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-3000}:3000" # Exposed for local development
    environment:
      MONGO_URI: ${MONGO_URI}
      JWT_SECRET: ${JWT_SECRET}
      PORT: 3000
      NODE_ENV: ${NODE_ENV:-production}
      FRONTEND_URLS: ${FRONTEND_URLS}
    networks:
      - web
      - backend
    depends_on:
      mongodb:
        condition: service_healthy
      mongodb-init:
        condition: service_completed_successfully
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=PathPrefix(`/api`) || PathPrefix(`/bitetrack`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.services.api.loadbalancer.server.port=3000"
      - "traefik.docker.network=bitetrack_web"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/bitetrack/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # BiteTrack Frontend Service
  bitetrack-frontend:
    build:
      context: ../services/frontend
      dockerfile: Dockerfile
    container_name: bitetrack-frontend
    restart: unless-stopped
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.priority=1" # Lowest priority (catch-all)
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "traefik.docker.network=bitetrack_web"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://127.0.0.1/health",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # BiteTrack MCP AI Service
  bitetrack-mcp:
    build:
      context: ../services/mcp
      dockerfile: Dockerfile
    container_name: bitetrack-mcp
    restart: unless-stopped
    ports:
      - "${MCP_PORT:-4000}:3001" # Exposed for local development
    environment:
      MCP_PORT: 3001
      NODE_ENV: ${NODE_ENV:-production}
      API_URL: http://bitetrack-api:3000
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - web
      - backend
    depends_on:
      bitetrack-api:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcp.rule=PathPrefix(`/mcp`)"
      - "traefik.http.routers.mcp.entrypoints=web"
      - "traefik.http.middlewares.mcp-stripprefix.stripprefix.prefixes=/mcp"
      - "traefik.http.routers.mcp.middlewares=mcp-stripprefix"
      - "traefik.http.services.mcp.loadbalancer.server.port=3001"
      - "traefik.docker.network=bitetrack_web"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3001/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  web:
    driver: bridge
    name: bitetrack_web
  backend:
    driver: bridge
    name: bitetrack_backend
    internal: true # No external access

volumes:
  mongodb_data:
  traefik_logs:
